panel.border = element_blank(),
panel.background = element_rect(fill = "white", colour = NA),
plot.background  = element_rect(fill = "white", colour = NA),
legend.key = element_blank(),
legend.title = element_text(size = 12),
legend.text = element_text(size = 10),
legend.position = "bottom")
cloneDend
Pal <- c("#E69F00", "#009E73", "#0072B2", "#D55E00", "#CC79A7", "#E41A1C", "#377EB8", "#984EA3", "#FF7F00", "#A65628", "#66C2A5", "#FC8D62", "#E78AC3", "#B3B3B3")
cloneDendA = ggplot() +
geom_segment(data = segment(cloneDData), aes(x = x, y = y, xend = xend, yend = yend2), size = 0.5) +
geom_point(data = cloneDendPoints, aes(x = x, y = y, fill = site, shape = region), size = 4, stroke = 0.25) +
# scale_fill_brewer(palette = "Dark2", name = "Site") +
scale_fill_manual(values = Pal, name= "Site")+
scale_shape_manual(values = c(21, 22, 23, 24, 25), name = "Region")+
geom_hline(yintercept = 0.12, color = "red", lty = 5, size = 0.75) + # creating a dashed line to indicate a clonal distance threshold
geom_text(data = subset(cloneDendPoints, subset = label %in% techReps), aes(x = x, y = (y - .045), label = label), angle = 90) + # spacing technical replicates further from leaf
geom_text(data = subset(cloneDendPoints, subset = !label %in% techReps), aes(x = x, y = (y - .025), label = label), angle = 90) +
labs(y = "Genetic distance (1 - IBS)") +
guides(fill = guide_legend(override.aes = list(shape = 22)))+
theme_classic()
cloneDend = cloneDendA + theme(
axis.title.x = element_blank(),
axis.text.x = element_blank(),
axis.line.x = element_blank(),
axis.ticks.x = element_blank(),
axis.title.y = element_text(size = 12, color = "black", angle = 90),
axis.text.y = element_text(size = 10, color = "black"),
axis.line.y = element_line(),
axis.ticks.y = element_line(),
panel.grid = element_blank(),
panel.border = element_blank(),
panel.background = element_rect(fill = "white", colour = NA),
plot.background  = element_rect(fill = "white", colour = NA),
legend.key = element_blank(),
legend.title = element_text(size = 12),
legend.text = element_text(size = 10),
legend.position = "bottom")
cloneDend
cloneDendA = ggplot() +
geom_segment(data = segment(cloneDData), aes(x = x, y = y, xend = xend, yend = yend2), size = 0.5) +
geom_point(data = cloneDendPoints, aes(x = x, y = y, fill = site, shape = region), size = 4, stroke = 0.25) +
# scale_fill_brewer(palette = "Dark2", name = "Site") +
scale_fill_manual(values = Pal, name= "Site")+
scale_shape_manual(values = c(21, 22, 23, 24, 25), name = "Region")+
geom_hline(yintercept = 0.12, color = "red", lty = 5, size = 0.75) + # creating a dashed line to indicate a clonal distance threshold
geom_text(data = subset(cloneDendPoints, subset = label %in% techReps), aes(x = x, y = (y - .045), label = label), angle = 90) + # spacing technical replicates further from leaf
geom_text(data = subset(cloneDendPoints, subset = !label %in% techReps), aes(x = x, y = (y - .025), label = label), angle = 90) +
labs(y = "Genetic distance (1 - IBS)") +
guides(fill = guide_legend(override.aes = list(shape = 22)))+
theme_classic()
cloneDend = cloneDendA + theme(
axis.title.x = element_blank(),
axis.text.x = element_blank(),
axis.line.x = element_blank(),
axis.ticks.x = element_blank(),
axis.title.y = element_text(size = 12, color = "black", angle = 90),
axis.text.y = element_text(size = 10, color = "black"),
axis.line.y = element_line(),
axis.ticks.y = element_line(),
panel.grid = element_blank(),
panel.border = element_blank(),
panel.background = element_rect(fill = "white", colour = NA),
plot.background  = element_rect(fill = "white", colour = NA),
legend.key = element_blank(),
legend.title = element_text(size = 12),
legend.text = element_text(size = 10),
legend.position = "bottom")
cloneDend
cloneDendA = ggplot() +
geom_segment(data = segment(cloneDData), aes(x = x, y = y, xend = xend, yend = yend2), size = 0.5) +
geom_point(data = cloneDendPoints, aes(x = x, y = y, fill = site, shape = region), size = 4, stroke = 0.25) +
# scale_fill_brewer(palette = "Dark2", name = "Site") +
scale_fill_manual(values = Pal, name= "Site")+
scale_shape_manual(values = c(21, 22, 23, 24, 25), name = "Region")+
geom_hline(yintercept = 0.12, color = "red", lty = 5, size = 0.75) + # creating a dashed line to indicate a clonal distance threshold
geom_text(data = subset(cloneDendPoints, subset = label %in% techReps), aes(x = x, y = (y - .045), label = label), angle = 90) + # spacing technical replicates further from leaf
geom_text(data = subset(cloneDendPoints, subset = !label %in% techReps), aes(x = x, y = (y - .025), label = label), angle = 90) +
labs(y = "Genetic distance (1 - IBS)") +
guides(fill = guide_legend(override.aes = list(shape = 22)))+
theme_classic()
cloneDendA
rlang::last_trace()
cloneDendA = ggplot() +
geom_segment(data = segment(cloneDData), aes(x = x, y = y, xend = xend, yend = yend2), size = 0.5) +
geom_point(data = cloneDendPoints, aes(x = x, y = y, fill = site, shape = region), size = 4, stroke = 0.25) +
# scale_fill_brewer(palette = "Dark2", name = "Site") +
scale_fill_manual(values = Pal, name= "Site")+
scale_shape_manual(values = c(21, 22, 23, 24, 25, 8), name = "Region")+
geom_hline(yintercept = 0.12, color = "red", lty = 5, size = 0.75) + # creating a dashed line to indicate a clonal distance threshold
geom_text(data = subset(cloneDendPoints, subset = label %in% techReps), aes(x = x, y = (y - .045), label = label), angle = 90) + # spacing technical replicates further from leaf
geom_text(data = subset(cloneDendPoints, subset = !label %in% techReps), aes(x = x, y = (y - .025), label = label), angle = 90) +
labs(y = "Genetic distance (1 - IBS)") +
guides(fill = guide_legend(override.aes = list(shape = 22)))+
theme_classic()
cloneDend = cloneDendA + theme(
axis.title.x = element_blank(),
axis.text.x = element_blank(),
axis.line.x = element_blank(),
axis.ticks.x = element_blank(),
axis.title.y = element_text(size = 12, color = "black", angle = 90),
axis.text.y = element_text(size = 10, color = "black"),
axis.line.y = element_line(),
axis.ticks.y = element_line(),
panel.grid = element_blank(),
panel.border = element_blank(),
panel.background = element_rect(fill = "white", colour = NA),
plot.background  = element_rect(fill = "white", colour = NA),
legend.key = element_blank(),
legend.title = element_text(size = 12),
legend.text = element_text(size = 10),
legend.position = "bottom")
cloneDend
ggsave("../../figures/pcli/cloneDend.pdf", plot = cloneDend, height = 8, width = 24, units = "in", dpi = 300)
ggsave("../../figures/pcli/cloneDend.png", plot = cloneDend, height = 8, width = 24, units = "in", dpi = 300)
setwd("~/Documents/GitHub/Urban-coral-population-genetics/code/pcli")
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
library(tidyverse)
popfile <- read.table(file = "../../data/pcli/ngsAdmix/pcliPopfile.txt", header = FALSE, col.names=c("sample", "site"), stringsAsFactors=FALSE)
site_order <- c(
"EmeraldReef",
"RainbowReef",
"FisherIsland",
"CoralCityCamera",
"StarIsland",
"MacArthurNorth",
"BelleIsle",
"PillarsReef",
"ArchCreek",
"FIUBiscayneBay",
"GracelandReef",
"FTL4Reef",
"BC1Reef",
"T328Reef",
"PeanutIsland"
)
site_factor <- factor(popfile$site, levels = site_order)
ord <- order(site_factor)
popfile_sorted <- popfile[ord, ]
write.table(popfile_sorted, "../../data/pcli/ngsAdmix/pcliPopfile_sorted.txt",
quote=FALSE, row.names=FALSE, col.names=FALSE, sep="\t")
# Unzips, loops through, and reorders each .Q file based on popfile_sorted
unzip("../../data/pcli/ngsAdmix/pcliQ.zip", exdir = "../../data/pcli/ngsAdmix/")
q_dir  <- "../../data/pcli/ngsAdmix/pcliQ"              # where .Q files now live
out_dir <- "../../data/pcli/ngsAdmix/pcliQ_sorted"   # new folder for reordered files
dir.create(out_dir, showWarnings = FALSE)
q_files <- list.files(q_dir, pattern="\\.Q$|\\.qopt$", full.names=TRUE)
length(q_files) # should be 800
for (file in q_files) {
q <- read.table(file, header=FALSE, colClasses = "character")
# must have same number of rows
stopifnot(nrow(q) == nrow(popfile_sorted))
q_sorted <- q[ord, ]
out_file <- file.path(out_dir, basename(file))
write.table(
q_sorted,
out_file,
quote = FALSE,
row.names = FALSE,
col.names = FALSE
)
}
# Cleanup
unlink(q_dir, recursive = TRUE) # Delete the uncompressed pcliQ directory
# Zip the pcliQ_sorted directory
out_dir_norm <- normalizePath(out_dir)
parent_dir   <- dirname(out_dir_norm)
folder_name  <- basename(out_dir_norm)
zipfile_path <- file.path(parent_dir, "pcliQ_sorted.zip")
cmd <- sprintf(
'cd "%s" && zip -r "%s" "%s"',
parent_dir,
basename(zipfile_path),
folder_name
)
cat("Running command:\n", cmd, "\n")
system(cmd)
if (file.exists(zipfile_path)) {
unlink(out_dir_norm, recursive = TRUE)
} # Delete the uncompressed pcliQ_sorted directory
setwd("~/Documents/GitHub/Urban-coral-population-genetics/code/pcli")
# setup rmarkdown environment first
knitr::opts_chunk$set(warning = FALSE, fig.align = 'left')
options(width = 88)
library(magrittr)
#setting working directory to the directory containing this .Rmd file
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
if (!require("pacman")) install.packages("pacman")
pacman::p_load_gh("pmartinezarbizu/pairwiseAdonis/pairwiseAdonis", "ropensci/rnaturalearthhires", "KarstensLab/microshades")
pacman::p_load("cowplot", "car", "ggrepel", "ggspatial", "paletteer", "patchwork", "rgdal", "rnaturalearth", "sf", "Hmisc", "MCMC.OTU", "pairwiseAdonis", "RColorBrewer", "Redmonder", "flextable", "lubridate", "officer", "adegenet", "dendextend", "gdata", "ggdendro", "hierfstat", "kableExtra", "poppr", "reshape2", "StAMPP", "vcfR", "vegan", "boa", "magick", "rgeos", "sdmpredictors", "ggcorrplot", "tidyverse", "TeachingDemos", "LaplacesDemon", "adespatial", "ggnewscale", "ggbeeswarm", "multcomp", "rstatix", "R.utils", "graph4lg")
options("scipen" = 10)
pacman::p_load("dendextend", "ggdendro", "tidyverse")
cloneBams = read.csv("../../data/pcli/pcliMetadata.csv") # list of bam files
cloneMa = as.matrix(read.table("../../data/pcli/ANGSD/clones/pcliClones.ibsMat")) # reads in IBS matrix produced by ANGSD
dimnames(cloneMa) = list(cloneBams[,2],cloneBams[,2])
clonesHc = hclust(as.dist(cloneMa),"ave")
clonePops = cloneBams$region
cloneSite = cloneBams$site
cloneDend = cloneMa %>% as.dist() %>% hclust(.,"ave") %>% as.dendrogram()
cloneDData = cloneDend %>% dendro_data()
# Making the branches hang shorter so we can easily see clonal groups
cloneDData$segments$yend2 = cloneDData$segments$yend
for(i in 1:nrow(cloneDData$segments)) {
if (cloneDData$segments$yend2[i] == 0) {
cloneDData$segments$yend2[i] = (cloneDData$segments$y[i] - 0.01)}}
cloneDendPoints = cloneDData$labels
cloneDendPoints$region = clonePops[order.dendrogram(cloneDend)]
cloneDendPoints$site=cloneSite[order.dendrogram(cloneDend)]
rownames(cloneDendPoints) = cloneDendPoints$label
cloneDendPoints$region = as.factor(cloneDendPoints$region)
cloneDendPoints$site = as.factor(cloneDendPoints$site)
# Making points at the leaves to place symbols for regions
point = as.vector(NA)
for(i in 1:nrow(cloneDData$segments)) {
if (cloneDData$segments$yend[i] == 0) {
point[i] = cloneDData$segments$y[i] - 0.01
} else {
point[i] = NA}}
cloneDendPoints$y = point[!is.na(point)]
techReps = c("urban_011", "urban_011_2", "urban_011_3", "urban_078", "urban_078_2", "urban_078_3", "urban_092", "urban_092_2", "urban_092_3", "urban_230", "urban_230_3")
cloneDendPoints$site = factor(cloneDendPoints$site,levels(cloneDendPoints$site)[c(3, 11, 12, 4, 2, 14, 8, 1, 13, 10, 7, 5, 6, 9)])
cloneDendPoints$region = factor(cloneDendPoints$region,levels(cloneDendPoints$region)[c(2, 3, 4, 5, 1,6)])
Pal <- c("#E69F00", "#009E73", "#0072B2", "#D55E00", "#CC79A7", "#E41A1C", "#377EB8", "#984EA3", "#FF7F00", "#A65628", "#66C2A5", "#FC8D62", "#E78AC3", "#B3B3B3")
cloneDendA = ggplot() +
geom_segment(data = segment(cloneDData), aes(x = x, y = y, xend = xend, yend = yend2), size = 0.5) +
geom_point(data = cloneDendPoints, aes(x = x, y = y, fill = site, shape = region), size = 4, stroke = 0.25) +
# scale_fill_brewer(palette = "Dark2", name = "Site") +
scale_fill_manual(values = Pal, name= "Site")+
scale_shape_manual(values = c(21, 22, 23, 24, 25, 8), name = "Region")+
geom_hline(yintercept = 0.12, color = "red", lty = 5, size = 0.75) + # creating a dashed line to indicate a clonal distance threshold
geom_text(data = subset(cloneDendPoints, subset = label %in% techReps), aes(x = x, y = (y - .045), label = label), angle = 90) + # spacing technical replicates further from leaf
geom_text(data = subset(cloneDendPoints, subset = !label %in% techReps), aes(x = x, y = (y - .025), label = label), angle = 90) +
labs(y = "Genetic distance (1 - IBS)") +
guides(fill = guide_legend(override.aes = list(shape = 22)))+
theme_classic()
cloneDend = cloneDendA + theme(
axis.title.x = element_blank(),
axis.text.x = element_blank(),
axis.line.x = element_blank(),
axis.ticks.x = element_blank(),
axis.title.y = element_text(size = 12, color = "black", angle = 90),
axis.text.y = element_text(size = 10, color = "black"),
axis.line.y = element_line(),
axis.ticks.y = element_line(),
panel.grid = element_blank(),
panel.border = element_blank(),
panel.background = element_rect(fill = "white", colour = NA),
plot.background  = element_rect(fill = "white", colour = NA),
legend.key = element_blank(),
legend.title = element_text(size = 12),
legend.text = element_text(size = 10),
legend.position = "bottom")
cloneDend
ggsave("../../figures/pcli/cloneDend.pdf", plot = cloneDend, height = 8, width = 24, units = "in", dpi = 300)
ggsave("../../figures/pcli/cloneDend.png", plot = cloneDend, height = 8, width = 24, units = "in", dpi = 300)
pacman::p_load("dendextend", "ggdendro", "tidyverse")
pacman::p_load("dendextend", "ggdendro", "tidyverse")
bams = read.csv("../../data/pcli/pcliMetadata.csv")[-c(5, 6, 7, 12, 16, 17, 19, 20, 24, 28, 35, 40, 42),] # list of bams files and their populations (tech reps removed)
ma = as.matrix(read.table("../../data/pcli/ANGSD/pcliNoClones.ibsMat")) # reads in IBS matrix produced by ANGSD
dimnames(ma) = list(bams[,2],bams[,2])
Hc = hclust(as.dist(ma),"ave")
Pops = bams$region
Site = bams$site
Dend = ma %>% as.dist() %>% hclust(.,"ave") %>% as.dendrogram()
DData = Dend %>% dendro_data()
# Making the branches hang shorter so we can easily see clonal groups
DData$segments$yend2 = DData$segments$yend
for(i in 1:nrow(DData$segments)) {
if (DData$segments$yend2[i] == 0) {
DData$segments$yend2[i] = (DData$segments$y[i] - 0.01)}}
DendPoints = DData$labels
DendPoints$region = Pops[order.dendrogram(Dend)]
DendPoints$site=Site[order.dendrogram(Dend)]
rownames(DendPoints) = DendPoints$label
DendPoints$region = as.factor(DendPoints$region)
DendPoints$site = as.factor(DendPoints$site)
# Making points at the leaves to place symbols for regions
point = as.vector(NA)
for(i in 1:nrow(DData$segments)) {
if (DData$segments$yend[i] == 0) {
point[i] = DData$segments$y[i] - 0.01
} else {
point[i] = NA}}
DendPoints$y = point[!is.na(point)]
DendPoints$site = factor(DendPoints$site,levels(DendPoints$site)[c(3, 11, 12, 4, 2, 14, 8, 1, 13, 10, 7, 5, 6, 9)])
DendPoints$region = factor(DendPoints$region,levels(DendPoints$region)[c(2, 3, 4, 5, 1,6)])
Pal <- c("#E69F00", "#009E73", "#0072B2", "#D55E00", "#CC79A7", "#E41A1C", "#377EB8", "#984EA3", "#FF7F00", "#A65628", "#66C2A5", "#FC8D62", "#E78AC3", "#B3B3B3")
DendA = ggplot() +
geom_segment(data = segment(DData), aes(x = x, y = y, xend = xend, yend = yend2), size = 0.5) +
geom_point(data = DendPoints, aes(x = x, y = y, fill = site, shape = region), size = 4, stroke = 0.25) +
# scale_fill_brewer(palette = "Dark2", name = "Site") +
scale_fill_manual(values = Pal, name= "Site")+
scale_shape_manual(values = c(21, 22, 23, 24, 25, 8), name = "Region")+
labs(y = "Genetic distance (1 - IBS)") +
guides(fill = guide_legend(override.aes = list(shape = 22)))+
theme_classic()
Dend = DendA + theme(
axis.title.x = element_blank(),
axis.text.x = element_blank(),
axis.line.x = element_blank(),
axis.ticks.x = element_blank(),
axis.title.y = element_text(size = 12, color = "black", angle = 90),
axis.text.y = element_text(size = 10, color = "black"),
axis.line.y = element_line(),
axis.ticks.y = element_line(),
panel.grid = element_blank(),
panel.border = element_blank(),
panel.background = element_rect(fill = "white", colour = NA),
plot.background  = element_rect(fill = "white", colour = NA),
legend.key = element_blank(),
legend.title = element_text(size = 12),
legend.text = element_text(size = 10),
legend.position = "bottom")
Dend
ggsave("../../figures/pcli/Dend.pdf", plot = Dend, height = 8, width = 24, units = "in", dpi = 300)
ggsave("../../figures/pcli/Dend.png", plot = Dend, height = 8, width = 24, units = "in", dpi = 300)
setwd("~/Documents/GitHub/Urban-coral-population-genetics/code/pcli")
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
# Load libraries
library(ggplot2)
library(dplyr)
library(patchwork)
# -------------------------
# 1. Read space-delimited input file
# -------------------------
data_file <- "../../data/pcli/ngsAdmix/pcliNgsAdmixLogfile_formatted"  # replace with your file
df <- read.table(data_file, header = FALSE, sep = "",
col.names = c("K", "LogLikelihood"), stringsAsFactors = FALSE)
# -------------------------
# 2. Clean columns and convert to numeric
# -------------------------
df$K <- as.numeric(trimws(df$K))
df$LogLikelihood <- as.numeric(trimws(df$LogLikelihood))
df <- df[!is.na(df$K) & !is.na(df$LogLikelihood), ]
if(nrow(df) == 0) stop("No valid data found in the file. Check file formatting.")
# -------------------------
# 3. Summarize mean and SD for each K
# -------------------------
summary_df <- df %>%
group_by(K) %>%
summarise(MeanLnP = mean(LogLikelihood, na.rm = TRUE),
SD = sd(LogLikelihood, na.rm = TRUE)) %>%
arrange(K)
# -------------------------
# 4. Calculate ΔK robustly
# -------------------------
L <- summary_df$MeanLnP
n <- nrow(summary_df)
deltaK <- rep(NA, n)
if(n >= 3) {
for(i in 2:(n-1)) {
Li_minus1 <- L[i-1]; Li <- L[i]; Li_plus1 <- L[i+1]; SDi <- summary_df$SD[i]
if(all(is.finite(c(Li_minus1, Li, Li_plus1, SDi))) && SDi != 0) {
deltaK[i] <- abs(Li_plus1 - 2*Li + Li_minus1) / SDi
}
}
}
summary_df$deltaK <- deltaK
# -------------------------
# 5. Identify all ΔK peaks
# -------------------------
is_peak <- rep(FALSE, n)
if(n >= 3 && any(!is.na(deltaK))) {
for(i in 2:(n-1)) {
if(!is.na(deltaK[i])) {
left <- deltaK[i-1]; right <- deltaK[i+1]
if((is.na(left) || deltaK[i] > left) && (is.na(right) || deltaK[i] > right)) {
is_peak[i] <- TRUE
}
}
}
}
peaks_df <- summary_df[is_peak, ]
# Identify global best K (largest ΔK)
global_best <- if(nrow(peaks_df) > 0) peaks_df[which.max(peaks_df$deltaK), ] else NULL
# -------------------------
# 6. Create plots
# -------------------------
# ΔK plot
if(!all(is.na(summary_df$deltaK))) {
p_deltaK <- ggplot(summary_df, aes(x = K, y = deltaK)) +
geom_line(color = "steelblue") +
geom_point() +
theme_minimal() +
labs(title = "ΔK Plot (Evanno Method)",
x = "K",
y = expression(Delta*K)) +
coord_cartesian(clip = "off")  # prevent label clipping
if(nrow(peaks_df) > 0) {
p_deltaK <- p_deltaK +
geom_point(data = peaks_df, aes(x = K, y = deltaK), color = "red", size = 3) +
geom_text(data = peaks_df, aes(x = K, y = deltaK, label = paste("K =", K)),
vjust = -0.5, color = "red", fontface = "bold", clip = "off")
}
if(!is.null(global_best)) {
p_deltaK <- p_deltaK +
geom_point(data = global_best, aes(x = K, y = deltaK), color = "darkred", size = 5) +
geom_text(data = global_best, aes(x = K, y = deltaK, label = paste("Best K =", K)),
vjust = -1, color = "darkred", fontface = "bold", clip = "off")
}
} else {
p_deltaK <- NULL
}
# Mean LogLikelihood plot
p_mean <- ggplot(summary_df, aes(x = K, y = MeanLnP)) +
geom_line(color = "darkgreen") +
geom_point(size = 3) +
theme_minimal() +
labs(title = "Mean Log Likelihood vs K",
x = "K",
y = "Mean Log Likelihood") +
coord_cartesian(clip = "off")
# Combine plots vertically
if(!is.null(p_deltaK)) {
p_combined <- p_deltaK / p_mean + plot_layout(heights = c(1,1))
} else {
p_combined <- p_mean
}
# -------------------------
# 7. Save combined plot
# -------------------------
output_file <- "../../figures/pcli/DeltaK_and_MeanLnP_plot.png"
ggsave(output_file, plot = p_combined, width = 6, height = 8, dpi = 300)
# -------------------------
# 8. Print peak info
# -------------------------
cat("Plot saved as", output_file, "\n")
if(!is.null(global_best)) {
cat("ΔK peaks at K =", paste(peaks_df$K, collapse = ", "), "\n")
cat("ΔK values:", paste(round(peaks_df$deltaK, 2), collapse = ", "), "\n")
cat("Global best K =", global_best$K, "with ΔK =", round(global_best$deltaK, 2), "\n")
} else if(nrow(summary_df) > 0) {
cat("ΔK could not be calculated; showing Mean Log Likelihood plot.\n")
} else {
cat("No valid data to plot.\n")
}
setwd("~/Documents/GitHub/Urban-coral-population-genetics/code/pcli")
library(tidyverse)
popfile <- read.table(file = "../../data/pcli/ngsAdmix/pcliPopfile.txt", header = FALSE, col.names=c("sample", "site"), stringsAsFactors=FALSE)
site_order <- c(
"EmeraldReef",
"RainbowReef",
"FisherIsland",
"CoralCityCamera",
"StarIsland",
"MacArthurNorth",
"BelleIsle",
"PillarsReef",
"ArchCreek",
"FIUBiscayneBay",
"GracelandReef",
"FTL4Reef",
"BC1Reef",
"T328Reef",
"PeanutIsland"
)
site_factor <- factor(popfile$site, levels = site_order)
ord <- order(site_factor)
popfile_sorted <- popfile[ord, ]
write.table(popfile_sorted, "../../data/pcli/ngsAdmix/pcliPopfile_sorted.txt",
quote=FALSE, row.names=FALSE, col.names=FALSE, sep="\t")
popfile$site
unique(popfile$site)
setdiff(unique(popfile$site), site_order)
table(popfile$site, useNA = "ifany")
popfile <- read.table(file = "../../data/pcli/ngsAdmix/pcliPopfile.txt", header = FALSE, col.names=c("sample", "site"), stringsAsFactors=FALSE)
site_order <- c(
"EmeraldReef", "RainbowReef", "Seaquarium", "FisherIsland", "CoralCityCamera", "StarIsland", "MacArthurNorth", "BelleIsle", "SouthCanyonReef", "PillarsReef", "HauloverInlet", "FIUBiscayneBay", "FTL4Reef", "PeanutIsland")
site_factor <- factor(popfile$site, levels = site_order)
ord <- order(site_factor)
popfile_sorted <- popfile[ord, ]
write.table(popfile_sorted, "../../data/pcli/ngsAdmix/pcliPopfile_sorted.txt",
quote=FALSE, row.names=FALSE, col.names=FALSE, sep="\t")
# Unzips, loops through, and reorders each .Q file based on popfile_sorted
unzip("../../data/pcli/ngsAdmix/pcliQ.zip", exdir = "../../data/pcli/ngsAdmix/")
q_dir  <- "../../data/pcli/ngsAdmix/pcliQ"              # where .Q files now live
out_dir <- "../../data/pcli/ngsAdmix/pcliQ_sorted"   # new folder for reordered files
dir.create(out_dir, showWarnings = FALSE)
q_files <- list.files(q_dir, pattern="\\.Q$|\\.qopt$", full.names=TRUE)
length(q_files) # should be 800
for (file in q_files) {
q <- read.table(file, header=FALSE, colClasses = "character")
# must have same number of rows
stopifnot(nrow(q) == nrow(popfile_sorted))
q_sorted <- q[ord, ]
out_file <- file.path(out_dir, basename(file))
write.table(
q_sorted,
out_file,
quote = FALSE,
row.names = FALSE,
col.names = FALSE
)
}
# Cleanup
unlink(q_dir, recursive = TRUE) # Delete the uncompressed pcliQ directory
# Zip the pcliQ_sorted directory
out_dir_norm <- normalizePath(out_dir)
parent_dir   <- dirname(out_dir_norm)
folder_name  <- basename(out_dir_norm)
zipfile_path <- file.path(parent_dir, "pcliQ_sorted.zip")
cmd <- sprintf(
'cd "%s" && zip -r "%s" "%s"',
parent_dir,
basename(zipfile_path),
folder_name
)
cat("Running command:\n", cmd, "\n")
system(cmd)
if (file.exists(zipfile_path)) {
unlink(out_dir_norm, recursive = TRUE)
} # Delete the uncompressed pcliQ_sorted directory
